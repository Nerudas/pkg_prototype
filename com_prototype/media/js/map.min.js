(function(a){a(document).ready(function(){var f=a("[data-prototype-map]"),i=f.attr("id"),j=a("[data-afterInit]"),h=a('[data-afterInit="show"]'),d=a('[data-afterInit="hide"]');h.hide();d.show();var c=localStorage.getItem("map"),e=Joomla.getOptions("prototypeMap","");if(c){c=a.parseJSON(c)}else{c={latitude:e.latitude,longitude:e.longitude,center:e.center,zoom:e.zoom};localStorage.setItem("map",JSON.stringify(c))}if(e.priority_center){c=a.parseJSON(localStorage.getItem("map"));if(e.priority_center.zoom){c.zoom=e.priority_center.zoom}if(e.priority_center.center){c.latitude=e.priority_center.center[0]*1;c.longitude=e.priority_center.center[1]*1;c.center=[c.latitude,c.longitude]}console.log(c);localStorage.setItem("map",JSON.stringify(c))}var g=setInterval(function(){if(a(f).width()>0&&a(f).height()>0){clearInterval(g);b()}},3);function b(){var k={center:c.center,zoom:c.zoom};ymaps.ready(function(){var A=new ymaps.Map(i,{center:k.center,zoom:k.zoom,controls:[]});A.behaviors.disable("dblClickZoom");var u=new ymaps.ObjectManager({clusterize:false});A.geoObjects.add(u);var l=0,B=0,D=false,p=false,n=[],w=a('[data-prototype-itemlist="items"]'),s=a('[data-prototype-counter="current"]'),y=a('[data-prototype-counter="total"]');function z(){if(D){D.abort()}if(p){p.abort()}a(w).html("");a(s).text(0);a(y).text(0);u.removeAll();l=0;B=0;q();m()}function m(){var E=a(v).serializeArray();E.push({name:"map",value:1});E.push({name:"id",value:e.catid});E.push({name:"layout",value:e.layout});a.each(t,function(F,G){E.push({name:"filter[coordinates]["+F+"]",value:G})});if(l==0){a(s).text(0);D=a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_prototype&task=map.getItemsTotal",data:E,success:function(F){var G=F.data;l=G;a(y).text(G);if(G>0){m()}}})}if(l>0){E.push({name:"limitstart",value:B});p=a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_prototype&task=map.getItems",data:E,success:function(G){if(G.success){var H=G.data,F=H.placemarks;a.each(F,function(K,J){var I={type:"Feature",id:J.id,geometry:{type:"Point",coordinates:a.parseJSON(J.coordinates)},options:{}};a.each(J.options,function(M,N){if(M=="customLayout"){M="iconLayout";if(a.inArray(J.id*1,n)!==-1){var O=a(N).clone(),L="";O.filter("[data-prototype-placemark]").attr("data-viewed","true");a.each(O,function(P){var Q=O[P].outerHTML;if(Q!=""&&Q!=undefined){L+=O[P].outerHTML}});N=L}N=ymaps.templateLayoutFactory.createClass(N)}I.options[M]=N});u.add(I)});a(H.html).appendTo(a(w));a(n).each(function(I,J){a('[data-prototype-item="'+J+'"]').attr("data-viewed","true")});if(a('[data-prototype-item][data-show="true"]').length>0){a('[data-prototype-item][data-show="false"]').hide()}B=B+H.count;a(s).text(B);if(B<l){m()}}}})}}var v=a("[data-prototype-filter]");a(v).on("submit",function(){z();return false});u.objects.events.add("click",function(G){var E=G.get("objectId"),F=u.objects.getById(E),H=F.id*1;a('[data-prototype-placemark="'+H+'"]').attr("data-viewed","true");a('[data-prototype-item="'+H+'"]').attr("data-viewed","true");n.push(H)});a("body").on("click","[data-prototype-show]",function(){var G=a(this),J=a(G).data("prototype-show"),E=a('[data-prototype-placemark="'+J+'"]'),F=a('[data-prototype-item="'+J+'"]');var I=1.4,H=350;a({scale:1}).animate({scale:I},{duration:H,step:function(K){E.css("transform","scale("+K+")")}},"linear");setTimeout(function(){a({scale:I}).animate({scale:1},{duration:H,step:function(K){E.css("transform","scale("+K+")")}},"linear")},H);setTimeout(function(){a(E).attr("data-viewed","true");a(F).attr("data-viewed","true")},H*2);n.push(J)});var t={north:90,south:-90,west:-180,east:180};function q(){var J=A.options.get("projection"),E=A.getGlobalPixelCenter(),O=A.getZoom(),P=A.container.getSize();var I=J.fromGlobalPixels([E[0]-P[0]/2,E[1]+P[1]/2],O);var H=J.fromGlobalPixels([E[0]+P[0]/2,E[1]-P[1]/2],O);var M=A.getBounds(),F=[I,H];var G=F[1][0],K=F[0][0],N=-180,L=180;if(M[0][1].toFixed(6)!=M[1][1].toFixed(6)){N=F[0][1];L=F[1][1]}t.north=G.toFixed(6);t.south=K.toFixed(6);t.west=N.toFixed(6);t.east=L.toFixed(6)}var o=a('[data-prototype-map-zoom="plus"]'),r=a('[data-prototype-map-zoom="current"]'),x=a('[data-prototype-map-zoom="minus"]');a(o).on("click",function(){if(A.getZoom()!=19){A.setZoom(A.getZoom()+1,{duration:200})}});a(x).on("click",function(){if(A.getZoom()!=0){A.setZoom(A.getZoom()-1,{duration:200})}else{a(x).attr("disabled","disabled")}});function C(E){if(E<19){a(o).removeAttr("disabled")}else{a(o).attr("disabled","disabled")}if(E>0){a(x).removeAttr("disabled")}else{a(x).attr("disabled","disabled")}}C(A.getZoom());r.text(A.getZoom());a("[data-prototype-map-geo]").on("click",function(){ymaps.geolocation.get().then(function(F){var E=F.geoObjects.position;A.setCenter(E,15)})});A.events.add("boundschange",function(F){if(F.get("newZoom")!=F.get("oldZoom")){var E=F.get("newZoom");k.zoom=E;r.text(E);C(E)}if(F.get("newCenter")!=F.get("oldCenter")){var H=F.get("newCenter")[0].toFixed(6),G=F.get("newCenter")[1].toFixed(6);k.center=[H,G];k.latitude=H;k.longitude=G}localStorage.setItem("map",JSON.stringify(k));z()});h.show();d.hide();j.removeAttr("data-afterInit");z()})}})})(jQuery);