(function(a){a(document).ready(function(){var f=a("[data-prototype-map]"),i=f.attr("id"),j=a("[data-afterInit]"),h=a('[data-afterInit="show"]'),d=a('[data-afterInit="hide"]');h.hide();d.show();var c=localStorage.getItem("map"),e=Joomla.getOptions("prototypeMap","");if(c){c=a.parseJSON(c)}else{c={latitude:e.latitude,longitude:e.longitude,center:e.center,zoom:e.zoom};localStorage.setItem("map",JSON.stringify(c))}if(e.priority_center){c=a.parseJSON(localStorage.getItem("map"));if(e.priority_center.zoom){c.zoom=e.priority_center.zoom}if(e.priority_center.center){c.latitude=e.priority_center.center[0]*1;c.longitude=e.priority_center.center[1]*1;c.center=[c.latitude,c.longitude]}localStorage.setItem("map",JSON.stringify(c))}var g=setInterval(function(){if(a(f).width()>0&&a(f).height()>0){clearInterval(g);b()}},3);function b(){var k={center:c.center,zoom:c.zoom};ymaps.ready(function(){var B=new ymaps.Map(i,{center:k.center,zoom:k.zoom,controls:[]});B.behaviors.disable("dblClickZoom");var u=new ymaps.ObjectManager({clusterize:false});B.geoObjects.add(u);var l=0,C=0,E=false,p=false,n=[],w=a('[data-prototype-itemlist="items"]'),s=a('[data-prototype-counter="current"]'),y=a('[data-prototype-counter="total"]');function A(){if(E){E.abort()}if(p){p.abort()}a(w).html("");a(s).text(0);a(y).text(0);u.removeAll();l=0;C=0;r();m()}function m(){var F=a(v).serializeArray();F.push({name:"id",value:e.catid});F.push({name:"layout",value:e.layout});F.push({name:"view",value:"map"});a.each(t,function(G,H){F.push({name:"filter[coordinates]["+G+"]",value:H})});if(l==0){a(s).text(0);E=a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_prototype&task=items.getTotal",data:F,success:function(G){var H=G.data;l=H;a(y).text(H);if(H>0){m()}}})}if(l>0){F.push({name:"limitstart",value:C});p=a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_prototype&task=items.getPlacemarks",data:F,success:function(H){if(H.success){var I=H.data,G=I.placemarks;a.each(G,function(L,K){var J={type:"Feature",id:K.id,geometry:{type:"Point",coordinates:a.parseJSON(K.coordinates)},options:{}};a.each(K.options,function(N,O){if(N=="customLayout"){N="iconLayout";if(a.inArray(K.id*1,n)!==-1){var P=a(O).clone(),M="";P.filter("[data-prototype-placemark]").attr("data-viewed","true");a.each(P,function(Q){var R=P[Q].outerHTML;if(R!=""&&R!=undefined){M+=P[Q].outerHTML}});O=M}O=ymaps.templateLayoutFactory.createClass(O)}J.options[N]=O});u.add(J)});a(I.html).appendTo(a(w));a(n).each(function(J,K){a('[data-prototype-item="'+K+'"]').attr("data-viewed","true")});if(a('[data-prototype-item][data-show="true"]').length>0){a('[data-prototype-item][data-show="false"]').hide()}C=C+I.count;a(s).text(C);if(C<l){m()}}}})}}var v=a("[data-prototype-filter]");a(v).on("submit",function(){A();return false});u.objects.events.add("click",function(H){var F=H.get("objectId"),G=u.objects.getById(F),I=G.id*1;a('[data-prototype-placemark="'+I+'"]').attr("data-viewed","true");a('[data-prototype-item="'+I+'"]').attr("data-viewed","true");n.push(I);z(I)});a("body").on("click","[data-prototype-show]",function(){var H=a(this),K=a(H).data("prototype-show"),F=a('[data-prototype-placemark="'+K+'"]'),G=a('[data-prototype-item="'+K+'"]');var J=1.4,I=350;a({scale:1}).animate({scale:J},{duration:I,step:function(L){F.css("transform","scale("+L+")")}},"linear");setTimeout(function(){a({scale:J}).animate({scale:1},{duration:I,step:function(L){F.css("transform","scale("+L+")")}},"linear")},I);setTimeout(function(){a(F).attr("data-viewed","true");a(G).attr("data-viewed","true");z(K)},I*2);n.push(K)});function z(K){var F=[];F.push({name:"id",value:e.catid});F.push({name:"item_id",value:K});var G=a("[data-prototype-balloon]"),I=a(G).find("[data-prototype-balloon-content]"),J=a(G).find("[data-prototype-balloon-loading]"),H=a(G).find("[data-prototype-balloon-error]");a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_prototype&task=items.getBalloon",cache:false,data:F,beforeSend:function(){a(I).html("");a(H).hide();a(J).show();showPrototypeMapBalloon()},complete:function(){a(J).hide()},success:function(L){if(L.success){var M=L.data;a(I).html(M.balloon)}else{a(H).show()}},error:function(){a(H).show()}})}var t={north:90,south:-90,west:-180,east:180};function r(){var K=B.options.get("projection"),F=B.getGlobalPixelCenter(),P=B.getZoom(),Q=B.container.getSize();var J=K.fromGlobalPixels([F[0]-Q[0]/2,F[1]+Q[1]/2],P);var I=K.fromGlobalPixels([F[0]+Q[0]/2,F[1]-Q[1]/2],P);var N=B.getBounds(),G=[J,I];var H=G[1][0],L=G[0][0],O=-180,M=180;if(N[0][1].toFixed(6)!=N[1][1].toFixed(6)){O=G[0][1];M=G[1][1]}t.north=H.toFixed(6);t.south=L.toFixed(6);t.west=O.toFixed(6);t.east=M.toFixed(6)}var o=a('[data-prototype-map-zoom="plus"]'),q=a('[data-prototype-map-zoom="current"]'),x=a('[data-prototype-map-zoom="minus"]');a(o).on("click",function(){if(B.getZoom()!=19){B.setZoom(B.getZoom()+1,{duration:200})}});a(x).on("click",function(){if(B.getZoom()!=0){B.setZoom(B.getZoom()-1,{duration:200})}else{a(x).attr("disabled","disabled")}});function D(F){if(F<19){a(o).removeAttr("disabled")}else{a(o).attr("disabled","disabled")}if(F>0){a(x).removeAttr("disabled")}else{a(x).attr("disabled","disabled")}}D(B.getZoom());q.text(B.getZoom());a("[data-prototype-map-geo]").on("click",function(){ymaps.geolocation.get().then(function(G){var F=G.geoObjects.position;B.setCenter(F,15)})});B.events.add("boundschange",function(G){if(G.get("newZoom")!=G.get("oldZoom")){var F=G.get("newZoom");k.zoom=F;q.text(F);D(F)}if(G.get("newCenter")!=G.get("oldCenter")){var I=G.get("newCenter")[0].toFixed(6),H=G.get("newCenter")[1].toFixed(6);k.center=[I,H];k.latitude=I;k.longitude=H}localStorage.setItem("map",JSON.stringify(k));A()});h.show();d.hide();j.removeAttr("data-afterInit");A()})}})})(jQuery);