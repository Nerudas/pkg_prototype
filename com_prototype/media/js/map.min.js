(function(a){a(document).ready(function(){var f=a("[data-prototype-map]"),i=f.attr("id"),j=a("[data-afterInit]"),h=a('[data-afterInit="show"]'),d=a('[data-afterInit="hide"]');h.hide();d.show();var c=localStorage.getItem("map"),e=Joomla.getOptions("prototypeMap","");if(c){c=a.parseJSON(c)}else{c={latitude:e.latitude,longitude:e.longitude,center:e.center,zoom:e.zoom};localStorage.setItem("map",JSON.stringify(c))}if(e.priority_center){c=a.parseJSON(localStorage.getItem("map"));if(e.priority_center.zoom){c.zoom=e.priority_center.zoom}if(e.priority_center.center){c.latitude=e.priority_center.center[0]*1;c.longitude=e.priority_center.center[1]*1;c.center=[c.latitude,c.longitude]}localStorage.setItem("map",JSON.stringify(c))}var g=setInterval(function(){if(a(f).width()>0&&a(f).height()>0){clearInterval(g);b()}},3);function b(){var k={center:c.center,zoom:c.zoom};ymaps.ready(function(){var C=new ymaps.Map(i,{center:k.center,zoom:k.zoom,controls:[]});C.behaviors.disable("dblClickZoom");var v=new ymaps.ObjectManager({clusterize:false});C.geoObjects.add(v);var l=0,D=0,F=false,p=false,n=[],x=a('[data-prototype-itemlist="items"]'),s=a('[data-prototype-counter="current"]'),z=a('[data-prototype-counter="total"]');function B(){if(F){F.abort()}if(p){p.abort()}a(x).html("");a(s).text(0);a(z).text(0);v.removeAll();l=0;D=0;r();m()}function m(){var G=a(w).serializeArray();G.push({name:"id",value:e.catid});G.push({name:"layout",value:e.layout});G.push({name:"view",value:"map"});G.push({name:"return_view",value:"map"});a.each(u,function(H,I){G.push({name:"filter[coordinates]["+H+"]",value:I})});if(l==0){a(s).text(0);F=a.ajax({type:"GET",dataType:"json",cache:false,url:"/index.php?option=com_prototype&task=items.getTotal",data:G,success:function(H){var I=H.data;l=I;a(z).text(I);if(I>0){m()}}})}if(l>0){G.push({name:"limitstart",value:D});p=a.ajax({type:"GET",dataType:"json",cache:false,url:"/index.php?option=com_prototype&task=items.getPlacemarks",data:G,success:function(I){if(I.success){var J=I.data,H=J.placemarks;a.each(H,function(M,L){var K={type:"Feature",id:L.id,geometry:{type:"Point",coordinates:a.parseJSON(L.coordinates)},options:{}};a.each(L.options,function(O,P){if(O=="customLayout"){O="iconLayout";if(a.inArray(L.id*1,n)!==-1){var Q=a(P).clone(),N="";Q.filter("[data-prototype-placemark]").attr("data-viewed","true");a.each(Q,function(R){var S=Q[R].outerHTML;if(S!=""&&S!=undefined){N+=Q[R].outerHTML}});P=N}P=ymaps.templateLayoutFactory.createClass(P)}K.options[O]=P});v.add(K)});a(J.html).appendTo(a(x));a(n).each(function(K,L){a('[data-prototype-item="'+L+'"]').attr("data-viewed","true")});if(a('[data-prototype-item][data-show="true"]').length>0){a('[data-prototype-item][data-show="false"]').hide()}D=D+J.count;a(s).text(D);if(D<l){m()}}}})}}var w=a("[data-prototype-filter]");a(w).on("submit",function(){B();return false});a(w).find('[name*="extra"]').on("change",function(){B();console.log("change");return false});v.objects.events.add("click",function(I){var G=I.get("objectId"),H=v.objects.getById(G),J=H.id*1;a('[data-prototype-placemark="'+J+'"]').attr("data-viewed","true");a('[data-prototype-item="'+J+'"]').attr("data-viewed","true");n.push(J);A(J)});a("body").on("click","[data-prototype-show]",function(){var I=a(this),L=a(I).data("prototype-show"),G=a('[data-prototype-placemark="'+L+'"]'),H=a('[data-prototype-item="'+L+'"]');var K=1.4,J=350;a({scale:1}).animate({scale:K},{duration:J,step:function(M){G.css("transform","scale("+M+")")}},"linear");setTimeout(function(){a({scale:K}).animate({scale:1},{duration:J,step:function(M){G.css("transform","scale("+M+")")}},"linear")},J);setTimeout(function(){a(G).attr("data-viewed","true");a(H).attr("data-viewed","true");A(L)},J*2);n.push(L)});if(e.item_id){var t=setInterval(function(){var G=a('[data-prototype-placemark="'+e.item_id+'"]');if(G.length>0){clearInterval(t);var I=1.4,H=350;a({scale:1}).animate({scale:I},{duration:H,step:function(J){G.css("transform","scale("+J+")")}},"linear");setTimeout(function(){a({scale:I}).animate({scale:1},{duration:H,step:function(J){G.css("transform","scale("+J+")")}},"linear")},H)}},3)}function A(L){var G=[];G.push({name:"id",value:e.catid});G.push({name:"item_id",value:L});G.push({name:"return_view",value:"map"});var H=a("[data-prototype-balloon]"),J=a(H).find("[data-prototype-balloon-content]"),K=a(H).find("[data-prototype-balloon-loading]"),I=a(H).find("[data-prototype-balloon-error]");a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_prototype&task=items.getBalloon",cache:false,data:G,beforeSend:function(){a(J).html("");a(I).hide();a(K).show();showPrototypeMapBalloon()},complete:function(){a(K).hide()},success:function(M){if(M.success){var N=M.data;a(J).html(N.balloon)}else{a(I).show()}},error:function(){a(I).show()}})}var u={north:90,south:-90,west:-180,east:180};function r(){var L=C.options.get("projection"),G=C.getGlobalPixelCenter(),Q=C.getZoom(),R=C.container.getSize();var K=L.fromGlobalPixels([G[0]-R[0]/2,G[1]+R[1]/2],Q);var J=L.fromGlobalPixels([G[0]+R[0]/2,G[1]-R[1]/2],Q);var O=C.getBounds(),H=[K,J];var I=H[1][0],M=H[0][0],P=-180,N=180;if(O[0][1].toFixed(6)!=O[1][1].toFixed(6)){P=H[0][1];N=H[1][1]}u.north=I.toFixed(6);u.south=M.toFixed(6);u.west=P.toFixed(6);u.east=N.toFixed(6)}var o=a('[data-prototype-map-zoom="plus"]'),q=a('[data-prototype-map-zoom="current"]'),y=a('[data-prototype-map-zoom="minus"]');a(o).on("click",function(){if(C.getZoom()!=19){C.setZoom(C.getZoom()+1,{duration:200})}});a(y).on("click",function(){if(C.getZoom()!=0){C.setZoom(C.getZoom()-1,{duration:200})}else{a(y).attr("disabled","disabled")}});function E(G){if(G<19){a(o).removeAttr("disabled")}else{a(o).attr("disabled","disabled")}if(G>0){a(y).removeAttr("disabled")}else{a(y).attr("disabled","disabled")}}E(C.getZoom());q.text(C.getZoom());a("[data-prototype-map-geo]").on("click",function(){ymaps.geolocation.get().then(function(H){var G=H.geoObjects.position;C.setCenter(G,15)})});C.events.add("boundschange",function(H){if(H.get("newZoom")!=H.get("oldZoom")){var G=H.get("newZoom");k.zoom=G;q.text(G);E(G)}if(H.get("newCenter")!=H.get("oldCenter")){var J=H.get("newCenter")[0].toFixed(6),I=H.get("newCenter")[1].toFixed(6);k.center=[J,I];k.latitude=J;k.longitude=I}localStorage.setItem("map",JSON.stringify(k));B()});h.show();d.hide();j.removeAttr("data-afterInit");B()})}})})(jQuery);