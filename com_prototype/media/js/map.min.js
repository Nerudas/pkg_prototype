(function(a){a(document).ready(function(){var f=a("[data-prototype-map]"),i=f.attr("id"),j=a("[data-afterInit]"),h=a('[data-afterInit="show"]'),d=a('[data-afterInit="hide"]');h.hide();d.show();var c=localStorage.getItem("map"),e=Joomla.getOptions("prototypeMap","");if(c){c=a.parseJSON(c)}else{c={latitude:e.latitude,longitude:e.longitude,center:e.center,zoom:e.zoom};localStorage.setItem("map",JSON.stringify(c))}if(e.priority_center){c=a.parseJSON(localStorage.getItem("map"));if(e.priority_center.zoom){c.zoom=e.priority_center.zoom}if(e.priority_center.center){c.latitude=e.priority_center.center[0]*1;c.longitude=e.priority_center.center[1]*1;c.center=[c.latitude,c.longitude]}localStorage.setItem("map",JSON.stringify(c))}var g=setInterval(function(){if(a(f).width()>0&&a(f).height()>0){clearInterval(g);b()}},3);function b(){var k={center:c.center,zoom:c.zoom};ymaps.ready(function(){var D=new ymaps.Map(i,{center:k.center,zoom:k.zoom,controls:[]});D.behaviors.disable("dblClickZoom");var v=new ymaps.ObjectManager({clusterize:false});D.geoObjects.add(v);var l=0,E=0,G=false,p=false,n=[],x=a('[data-prototype-itemlist="items"]'),s=a('[data-prototype-counter="current"]'),z=a('[data-prototype-counter="total"]');function C(){if(G){G.abort()}if(p){p.abort()}a(x).html("");a(s).text(0);a(z).text(0);v.removeAll();l=0;E=0;r();m()}function m(){var H=a(w).serializeArray();H.push({name:"id",value:e.catid});H.push({name:"layout",value:e.layout});H.push({name:"view",value:"map"});H.push({name:"return_view",value:"map"});a.each(u,function(I,J){H.push({name:"filter[coordinates]["+I+"]",value:J})});if(l==0){a(s).text(0);G=a.ajax({type:"GET",dataType:"json",cache:false,url:"/index.php?option=com_prototype&task=items.getTotal",data:H,success:function(I){var J=I.data;l=J;a(z).text(J);if(J>0){m()}}})}if(l>0){H.push({name:"limitstart",value:E});p=a.ajax({type:"GET",dataType:"json",cache:false,url:"/index.php?option=com_prototype&task=items.getPlacemarks",data:H,success:function(J){if(J.success){var K=J.data,I=K.placemarks;a.each(I,function(N,M){var L={type:"Feature",id:M.id,geometry:{type:"Point",coordinates:a.parseJSON(M.coordinates)},options:{}};a.each(M.options,function(P,Q){if(P=="customLayout"){if(a.inArray(M.id*1,n)!==-1){var R=a(Q).clone(),O="";R.filter("[data-prototype-placemark]").attr("data-viewed","true");a.each(R,function(S){var T=R[S].outerHTML;if(T!=""&&T!=undefined){O+=R[S].outerHTML}});Q=O}L.options[P]=Q;P="iconLayout";Q=ymaps.templateLayoutFactory.createClass(Q)}if(a.inArray(M.id*1,n)!==-1&&P=="iconShape"){Q.coordinates=Q.coordinates_viewed}L.options[P]=Q});v.add(L)});a(K.html).appendTo(a(x));a(n).each(function(L,M){a('[data-prototype-item="'+M+'"]').attr("data-viewed","true")});if(a('[data-prototype-item][data-show="true"]').length>0){a('[data-prototype-item][data-show="false"]').hide()}E=E+K.count;a(s).text(E);if(E<l){m()}}}})}}var w=a("[data-prototype-filter]");a(w).on("submit",function(){C();return false});a(w).find('[name*="extra"]').on("change",function(){C();console.log("change");return false});v.objects.events.add("click",function(H){A(H.get("objectId"))});a("body").on("click","[data-prototype-show-balloon]",function(){var I=a(this),L=a(I).data("prototype-show"),H=a('[data-prototype-placemark="'+L+'"]');var K=1.4,J=350;a({scale:1}).animate({scale:K},{duration:J,step:function(M){H.css("transform","scale("+M+")")}},"linear");setTimeout(function(){a({scale:K}).animate({scale:1},{duration:J,step:function(M){H.css("transform","scale("+M+")")}},"linear")},J);setTimeout(function(){A(L)},J*2)});function A(N){var J=v.objects.getById(N),K=a('[data-prototype-item="'+N+'"]');var H=J.options.iconShape;H.coordinates=H.coordinates_viewed;var M=a(J.options.customLayout).clone(),I="";M.filter("[data-prototype-placemark]").attr("data-viewed","true");a.each(M,function(O){var P=M[O].outerHTML;if(P!=""&&P!=undefined){I+=M[O].outerHTML}});var L=ymaps.templateLayoutFactory.createClass(I);v.objects.setObjectOptions(N,{iconLayout:L,iconShape:H});a(K).attr("data-viewed","true");B(N);n.push(N*1)}if(e.item_id){var t=setInterval(function(){var H=a('[data-prototype-placemark="'+e.item_id+'"]');if(H.length>0){clearInterval(t);var J=1.4,I=350;a({scale:1}).animate({scale:J},{duration:I,step:function(K){H.css("transform","scale("+K+")")}},"linear");setTimeout(function(){a({scale:J}).animate({scale:1},{duration:I,step:function(K){H.css("transform","scale("+K+")")}},"linear")},I)}},3)}function B(M){var H=[];H.push({name:"id",value:e.catid});H.push({name:"item_id",value:M});H.push({name:"return_view",value:"map"});var I=a("[data-prototype-balloon]"),K=a(I).find("[data-prototype-balloon-content]"),L=a(I).find("[data-prototype-balloon-loading]"),J=a(I).find("[data-prototype-balloon-error]");a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_prototype&task=items.getBalloon",cache:false,data:H,beforeSend:function(){a(K).html("");a(J).hide();a(L).show();showPrototypeMapBalloon()},complete:function(){a(L).hide()},success:function(N){if(N.success){var O=N.data;a(K).html(O.balloon)}else{a(J).show()}},error:function(){a(J).show()}})}var u={north:90,south:-90,west:-180,east:180};function r(){var M=D.options.get("projection"),H=D.getGlobalPixelCenter(),R=D.getZoom(),S=D.container.getSize();var L=M.fromGlobalPixels([H[0]-S[0]/2,H[1]+S[1]/2],R);var K=M.fromGlobalPixels([H[0]+S[0]/2,H[1]-S[1]/2],R);var P=D.getBounds(),I=[L,K];var J=I[1][0],N=I[0][0],Q=-180,O=180;if(P[0][1].toFixed(6)!=P[1][1].toFixed(6)){Q=I[0][1];O=I[1][1]}u.north=J.toFixed(6);u.south=N.toFixed(6);u.west=Q.toFixed(6);u.east=O.toFixed(6)}var o=a('[data-prototype-map-zoom="plus"]'),q=a('[data-prototype-map-zoom="current"]'),y=a('[data-prototype-map-zoom="minus"]');a(o).on("click",function(){if(D.getZoom()!=19){D.setZoom(D.getZoom()+1,{duration:200})}});a(y).on("click",function(){if(D.getZoom()!=0){D.setZoom(D.getZoom()-1,{duration:200})}else{a(y).attr("disabled","disabled")}});function F(H){if(H<19){a(o).removeAttr("disabled")}else{a(o).attr("disabled","disabled")}if(H>0){a(y).removeAttr("disabled")}else{a(y).attr("disabled","disabled")}}F(D.getZoom());q.text(D.getZoom());a("[data-prototype-map-geo]").on("click",function(){ymaps.geolocation.get().then(function(I){var H=I.geoObjects.position;D.setCenter(H,15)})});D.events.add("boundschange",function(I){if(I.get("newZoom")!=I.get("oldZoom")){var H=I.get("newZoom");k.zoom=H;q.text(H);F(H)}if(I.get("newCenter")!=I.get("oldCenter")){var K=I.get("newCenter")[0].toFixed(6),J=I.get("newCenter")[1].toFixed(6);k.center=[K,J];k.latitude=K;k.longitude=J}localStorage.setItem("map",JSON.stringify(k));C()});h.show();d.hide();j.removeAttr("data-afterInit");C()})}})})(jQuery);